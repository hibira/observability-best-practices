# ハイブリッドとマルチクラウドのためのベストプラクティス

## はじめに

マルチクラウドとは、自社のワークロードを運用するために複数のクラウドサービスプロバイダーを同時に利用することを指し、ハイブリッドとはオンプレミスとクラウドの両方の環境にわたってワークロードを拡張することを指します。ハイブリッドおよびマルチクラウド環境におけるオブザーバビリティは、ツールの多様性、レイテンシー、異種のワークロードにより、大幅に複雑になる可能性があります。にもかかわらず、これは開発およびビジネスの両方のユーザーにとって共通の目標であり続けています。豊富な製品とサービスのエコシステムがこれに対応しています。

しかし、クラウドネイティブなワークロードにとってのオブザーバビリティツールの有用性は劇的に異なる場合があります。 コンテナ化されたバッチ処理ワークロードを監視する要件と、サーバーレスフレームワークを使用したリアルタイムの銀行アプリケーションの要件を比較してください。両方ともログ、メトリクス、トレースがありますが、それらを観察するためのツールチェーンは異なり、クラウドネイティブ、オープンソース、ISV製品が数多く利用できます。 Prometheusなどのオープンソースツールは、1つには最適な適合である可能性がありますが、マネージドサービスとして提供されるクラウドネイティブツールの方が要件を満たす可能性が高くなります。

これにマルチクラウドとハイブリッドの複雑さが加わると、アプリケーションからの洞察を取得することはかなり難しくなります。

これらの次元を追加し、オブザーバビリティへのアプローチを容易にするために、お客様は統一されたインターフェイスを備えた単一のツールチェーンに投資する傾向があります。 結局のところ、信号対雑音比を下げることは通常良いことです! しかし、単一のアプローチはすべてのユースケースには機能せず、さまざまなプラットフォームの運用モデルは混乱を招く可能性があります。 私たちの目標は、ニーズに合わせた意思決定を支援し、問題が発生したときの平均修復時間を短縮することです。 以下は、あらゆる規模のお客様や業界のお客様と協力して学んだベストプラクティスです。

 !!! info
    これらのベストプラクティスは、エンタープライズアーキテクト、開発者、DevOpsなど、幅広い役割を対象としています。 これらを組織のビジネスニーズの観点から評価し、分散型環境でのオブザーバビリティがどのように最大限の価値を提供できるかを検討することをお勧めします。

## ツールが判断を下すことを許可しない

アプリケーション、ツール、プロセスは、売上や顧客満足度の向上などのビジネス目標を達成するのに役立ちます。
技術戦略を立てる際には、こうしたビジネス目標達成のために可能な限りのことをする必要があります。
しかしながら、目標達成に役立つものは単なるツールであり、戦略そのものを支えるべきものです。
たとえば、家を建てる必要がある場合、ツールに設計や建設の方法を尋ねることはありません。
ツールは目的を達成する手段に過ぎません。

単一かつ同質の環境では、ツールの選定は比較的容易です。
なぜなら、1つのアプリケーションを1つの環境で実行している場合、ツールを全体的に同じにできるからです。
しかし、ハイブリッド環境やマルチクラウド環境では状況が異なり、これらの環境にまたがるワークロードを観測することの付加価値に注目し続けることが重要です。
各クラウドサービスプロバイダー(CSP)には独自のネイティブな可観測性ソリューションがあり、豊富なパートナーや独立系ソフトウェアベンダー(ISV)のソリューションを利用することもできます。

複数の環境で運用しているからといって、すべてのワークロードに1つのツールを使用することが望ましいとは限らず、むしろそうは言えません。
これは潜在的に、ワークロードを観測するために複数のサービス、フレームワーク、プロバイダを使用することを意味します。
詳細は以下の「[シングルパネルよりワークロードのコンテキストが重要](#a-single-pane-of-glass-is-less-important-than-your-workloads-context)」を参照してください。
とにかく、ツールを実装する際には、将来的に可観測性ソリューションを進化させることができるように「[双方向ドア](https://aws.amazon.com/executive-insights/content/how-amazon-defines-and-operationalizes-a-day-1-culture/)」を作成することを忘れないでください。

以下は、避けるべき「ツール優先」の結果の例です。

1. 将来的にアップグレードしたり、新しいソリューションに移行するための双方向ドアなしに、1つのツールの実装に集中することは、そうでなければ回避できた技術的負債を生み出す可能性があります。これは、ツールがソリューションとなり、いつの日か解決すべき問題となる場合に発生する可能性があります。

2. ボリュームディスカウントにより、1つのツールを社内標準として使用することになる場合、実際にはそのツールの機能の恩恵を受けられない可能性があります。これは「コスト優先」で、意図せずにモノリシックなアンチパターンを生み出す可能性があります。これにより、ボリュームのしきい値以下を維持するためにテレメトリの収集を控えることにつながり、結果として可観測性ツールの利用を阻害することになります。

3. 既存のトレース収集インフラがないが、ログとメトリクスの収集器が豊富にある場合、トレース(通常はこの種類のテレメトリ)を全く収集しないことで、不完全な可観測性ソリューションにつながる可能性があります。

4. 研修コストとトレーニングコストを削減するために、サポートスタッフを1つのツールチェーンにのみ訓練しているが、その結果として他の可観測性パターンの潜在的な価値が低下している。

!!! success
    可観測性戦略をツールが左右している場合は、アプローチを逆転させる必要があります。
    ツールは可観測性を可能にし、強化するためのものです。選択肢を制限するためではありません。

!!! success
    ツールの乱立は、企業が実際に苦慮している本物の問題です。
    しかし、単一のツールチェーンへの根本的な移行は、同様に可観測性ソリューションの有用性を低下させる可能性があります。
    ハイブリッド環境とマルチクラウド環境のワークロードには、各プラットフォーム固有のテクノロジーがあり、各CSPの高レベルサービスは有用です。
    ただし、シングルソース製品を使用することのトレードオフには、価値ベースの分析が必要です。
    このリスクの一部を軽減するアプローチについては、「[OpenTelemetry への投資](#invest-in-opentelemetry)」を参照してください。

## (オブザーバビリティ) データには重力がある

すべてのデータには重力があり、それがワークロード、ソリューション、ツール、人、プロセス、プロジェクトを引き寄せることを意味します。たとえば、顧客の取引が含まれるデータベースは、コンピューティングと分析のワークロードを引き寄せる力となります。これはワークロードの配置場所、環境、運用方法に直接影響します。同じことがオブザーバビリティ シグナルにも当てはまりますが、このデータが生み出す重力は、ワークロードと組織のコンテキストに結び付いています(「[シングルパネオブグラスは、ワークロードのコンテキストよりも重要ではない](#a-single-pane-of-glass-is-less-important-than-your-workloads-context)」を参照)。

オブザーバビリティ テレメトリのコンテキストを、関連する基礎となるワークロードやデータから完全に切り離すことはできません。同じルールがここでも適用されます。テレメトリはデータであり、重力を持っています。これは、シグナルを集約および分析するテレメトリ エージェント、コレクター、またはシステムを配置する場所に影響を与えるはずです。

!!! tip
    オブザーバビリティ データの時間経過とともにの価値は、ほかのデータ型よりもかなり低くなります。オブザーバビリティ データの「半減期」と呼ぶことができます。テレメトリを別の環境に中継する追加のレイテンシを、発生する可能性のある問題に対するアラートの要件と比較衡量する前の、このデータの強制的な価値の下落と見なしてください。 

!!! success
    この集計からビジネス上のメリットが得られる場合にのみ、環境間でデータを送信することがベスト プラクティスです。データのクエリに単一のソースを用意することは、それ自体で多くのビジネス ニーズを満たすわけではなく、望ましくないほど高価なソリューションとなり、障害点が増える可能性があります。

## 1枚のガラスよりもワークロードのコンテキストが重要

よくある要望の1つに、すべてのワークロードを観測するための「シングルパネオブガラス」があります。これは、可能な限りシンプルな方法で、できるだけ多くのデータを表示したいという自然な欲求から生じます。そして、作業の変更、不満、診断時間を減らしたいと考えます。オブザーバビリティソリューション全体を一度に表示できる1つのインターフェイスを作成することは便利ですが、テレメトリデータをその発生元のコンテキストから切り離すというトレードオフが伴う場合があります。 

例えば、100台のサーバーのCPU利用率を表示するダッシュボードは、消費における異常なスパイクを示す可能性がありますが、これはなぜこのようなことが発生したのか、あるいはこのような動作を招く要因が何かを説明することはありません。そして、このメトリクスの重要性がすぐには明らかではないでしょう。

私たちは、シングルパネオブガラスをあまりにも積極的に追求するあまり、すべてのビジネスコンテキストが失われてしまうケースを見てきました。そして、1つのツールですべてを見ようとすることは、実際にはそのデータの価値を薄めてしまう可能性があります。ダッシュボードやツールは、[ストーリーを伝える必要があります](/tools/dashboards/)。そして、このストーリーには、ワークロード内のイベントによって影響を受けるビジネスメトリクスとアウトカムを含める必要があります。

さらに、ツールは運用モデルに合わせる必要があります。グローバルなサポートチームがすべての環境にアクセスできる場合、シングルパネオブガラスは価値を追加できますが、1つのワークロードや単一のクラウドプロバイダーまたはハイブリッド環境にのみアクセスできる場合は、このアプローチを通じて価値が追加されることはありません。このような場合、各環境内でネイティブにダッシュボードを作成できるようにすることで、迅速に価値を提供し、将来的な変更にも柔軟に対応できます。

!!! success
    オブザーバビリティデータの価値は、発生元のアプリケーションと深く統合されています。テレメトリにはその環境からのコンテキスト認識が必要です。ハイブリッドおよびマルチクラウド環境では、テクノロジー間の違いが大きいため、コンテキストの必要性はさらに高まります(ただし、Kubernetesなどのシステムは、クラウドプロバイダーやオンプレミス間で似通ったものになる場合があります)。

!!! success
    分散システムのシングルパネオブガラスを構築する際は、ビジネスメトリクスとサービスレベルオブジェクティブ(SLO)を、これらのSLOに貢献する他のデータ(インフラストラクチャメトリクスなど)と同じビューに表示してください。これにより、そうでない場合に不足しがちなコンテキストを提供できます。


!!! tip
    シングルパネオブガラスは、問題を迅速に診断し、検出時間(MTTD)を短縮して、平均復旧時間(MTTR)を改善するのに役立ちますが、これはテレメトリデータの意味を保持できる場合に限られます。保持できない場合、シングルパネオブガラスアプローチは時間を要する、あるいは運用チームにとってマイナスの影響を及ぼす可能性があります。

!!! success
    シングルパネオブガラスの価値が判断できない場合や、ワークロードが単一のクラウドプロバイダーまたはオンプレミス環境に完全に縛られている場合は、上位レベルのビジネスメトリクスのみをシングルパネオブガラスにロールアップし、生のメトリクスやその他の影響要因は元の環境に残すことを検討してください。

## OpenTelemetry への投資

オブザーバビリティベンダーのランドスケープ全体で、OpenTelemetry(OTel) は事実上の標準となっています。OTEL はテレメトリの各タイプを 1 つ以上の Collector にマーシャルできます。これにはクラウドネイティブサービスや、さまざまな SaaS および ISV 製品を含めることができます。OTel エージェントと Collector は、OpenTelemetry プロトコル(OTLP)を使用して通信します。これにより、さまざまなデプロイメントパターンを可能にする形式でシグナルをカプセル化します。

最も価値のあるトランザクショントレースを収集するには、ビジネスとインフラのコンテキストとともに、アプリケーションにトレース収集を統合する必要があります。いくつかの自動インスツルメンテーションエージェントは、ほとんど労力を必要とせずにこれを実行できます。ただし、最も洗練されたユースケースでは、トランザクショントレースをサポートするためにコード変更が必要です。これにより、技術的負債が発生し、ワークロードが特定のテクノロジーに縛られます。 

OTel は、span のコンセプトを使用して、ログ、メトリクス、トレースをキャプチャします。Span には、単一のトランザクションからグループ化されたこれらのシグナルが含まれ、コンテキスト化された検索可能なオブジェクトにパッケージ化されます。これは、アプリケーションイベントからのシグナルを 1 つのシンプルなエンティティで表示できることを意味します。たとえば、Web サイトにログインするユーザーと、これが統合しているすべての下流サービスへのリクエストを、単一の span として提示できます。

!!! tip
    OTel はアプリケーショントレースに限定されておらず、ログとメトリクスに広く使用されています。また、[多くの ISV 製品が今日 OTLP を直接受け入れています](https://opentelemetry.io/ecosystem/vendors/)。
    
!!! Success
    OTel を使用してアプリケーションにインスツルメンテーションを適用することで、将来的に 1 つのオブザーバビリティプラットフォームから別のプラットフォームに移行する場合でも、アプリケーション層でのインスツルメンテーションの置き換えの必要性がなくなります。これにより、オブザーバビリティソリューションの一部が [two-way door](https://aws.amazon.com/executive-insights/content/how-amazon-defines-and-operationalizes-a-day-1-culture/) になります。
    
!!! success
    OTelは将来の変更に対応可能でスケーラブルであり、アプリケーションコードを変更することなく収集および分析システムを将来的に変更しやすくするため、効率的な [left shift](https://www.youtube.com/watch?v=99r7cxKW8Rg) です。
