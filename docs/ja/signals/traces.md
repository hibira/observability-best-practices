# トレース

トレースは、リクエストがアプリケーションの様々なコンポーネントを通過する際の全体の経路を表します。

ログやメトリクスとは異なり、*トレース* は複数のアプリケーションやサービスからのイベントで構成され、レスポンス待ち時間、サービス障害、リクエストパラメータ、メタデータなど、サービス間の接続に関する文脈情報が含まれています。

!!! tip
    [ログ](../../signals/logs/) とトレースには概念的な類似性がありますが、ログは通常単一のサービスやアプリケーションの実行に限定されるのに対し、トレースは複数サービスにまたがる文脈で考えられることを意図しています。

現在の開発者は、モジュール化された分散アプリケーションの構築に傾いています。これらを [Service Oriented Architecture](https://en.wikipedia.org/wiki/Service-oriented_architecture) と呼ぶ人もいれば、[マイクロサービス](https://aws.amazon.com/jp/microservices/) と呼ぶ人もいます。名称は何であれ、このようなゆるく結合されたアプリケーションで何か問題が発生した場合、ログやイベントを見るだけでは、インシデントの根本原因を追跡するのに十分ではないかもしれません。リクエストフローを完全に可視化することが不可欠であり、ここにトレースの価値があります。因果関係のあるイベントの一連で、エンドツーエンドのリクエストフローを描くことで、トレースはその可視化を支援します。

トレースはオブザーバビリティの不可欠な柱であり、システムに入ってくるリクエストの流れの基本情報を提供します。

!!! tip
    トレースの一般的な使用例には、パフォーマンスプロファイリング、本番環境の問題のデバッグ、障害の根本原因分析などがあります。

## すべての統合ポイントを計装する

ワークロードの機能とコードがすべて一か所にある場合、リクエストがさまざまな関数を通過する方法をソースコードから確認するのは簡単です。システムレベルでは、アプリが実行されているマシンがわかり、何か問題が発生した場合は、すぐにルート原因を特定できます。しかし、さまざまなコンポーネントがゆるく結合され、分散環境で実行されているマイクロサービスベースのアーキテクチャでそれを行うことを想像してみてください。相互接続されたリクエストごとにログを確認するために、多数のシステムにログインするのは現実的ではありません。

このような場合、オブザーバビリティが役立ちます。計装は、オブザーバビリティを高めるための重要なステップです。広い意味では、計装とはコードを使用してアプリケーションのイベントを測定することです。

一般的な計装アプローチは、システムに入ってくる各リクエストに一意のトレース ID を割り当て、そのトレース ID を追加のメタデータを付けながら、さまざまなコンポーネントを通過させることです。

!!! success
    サービス間の接続すべてを計装し、トレースを中央のコレクターに送信する必要があります。このアプローチにより、ワークロードの不透明な側面を見ることができます。

!!! success
    自動計装エージェントやライブラリを使用すると、アプリケーションの計装をほぼ自動化できます。

## トランザクション時間とステータスは重要なので、測定しましょう!

適切に計装されたアプリケーションは、エンドツーエンドのトレースを生成できます。これは次のようなウォーターフォール形式のグラフとして表示できます:

![WaterFall Trace](../images/waterfall-trace.png)

または、サービスマップとして表示できます:

![servicemap Trace](../images/service-map-trace.png)

すべてのインタラクションのトランザクション時間と応答コードを測定することが重要です。これにより、全体の処理時間を計算し、SLA、SLO、ビジネス KPI への準拠を追跡できます。

!!! success
    インタラクションの応答時間とステータスコードを理解して記録することで、全体的なリクエストパターンとワークロードの健全性に寄与する要因を把握できます。

## メタデータ、アノテーション、ラベルはあなたの最良の友人です

トレースは永続化され、一意の ID が割り当てられます。各トレースは、リクエストのパス内の各ステップを記録する *スパン* または *セグメント* (ツールによって異なります) に分割されます。スパンは、トレースが対話するエンティティを示し、親トレースと同様に、各スパンには一意の ID とタイムスタンプが割り当てられ、追加のデータやメタデータも含めることができます。この情報はデバッグに役立ちます。なぜなら、問題が発生した正確な時間と場所を示すからです。

これは実際の例で最もよく説明できます。Eコマースアプリケーションは、認証、認可、配送、在庫、支払い処理、フルフィルメント、商品検索、レコメンデーションなど、多くのドメインに分割される可能性があります。しかし、これらの相互接続されたドメインすべてのトレースを検索するのではなく、顧客 ID でトレースにラベル付けすることで、その特定の人に関連する対話のみを検索できます。これにより、運用上の問題を診断する際に、すぐに検索範囲を絞り込むことができます。

!!! success
    ベンダー間で命名規則が異なる場合がありますが、各トレースにはメタデータ、ラベル、アノテーションを追加でき、これらはワークロード全体で検索可能です。追加するにはコーディングが必要ですが、ワークロードの観測可能性が大幅に向上します。

!!! warning
    トレースはログではありません。したがって、トレースに含めるメタデータは控えめにしてください。また、トレースデータは、サンプリングレートが高くても、フォレンジックや監査を目的としたものではありません。
