# メトリクス

メトリクスは、作成された時間順に並べられた一連の数値です。環境内のサーバー数、ディスク使用量、1 秒あたりの処理リクエスト数、リクエスト完了の待ち時間など、さまざまなものを追跡するために使用されます。

しかし、メトリクスはインフラストラクチャやアプリケーションの監視に限定されるものではありません。むしろ、売上、コールキュー、顧客満足度など、あらゆる種類のビジネスやワークロードを追跡するために使用できます。実際、メトリクスは運用データとビジネスメトリクスを組み合わせた場合に最も役立ち、包括的な視点とオブザーバブルなシステムを提供します。

メトリクスに関する追加のコンテキストについては、[OpenTelemetry のドキュメントページ](https://opentelemetry.io/docs/concepts/signals/metrics/) を参照するとよいでしょう。

## 重要業績評価指標 (KPI) を把握し、測定しましょう

メトリクスで最も重要なことは、*正しいものを測定すること* です。そして、それが何かは人によって異なります。EC サイトでは 1 時間あたりの売上が重要な KPI かもしれませんが、ベーカリーでは 1 日に作られたクロワッサンの数の方が重要でしょう。

!!! warning
	ビジネスの KPI を網羅的に示す単一の情報源はありません。プロジェクトやアプリケーションを十分に理解し、*アウトプットの目標* が何かを把握する必要があります。

最初のステップは、上位目標を特定することです。その目標は、インフラストラクチャからのメトリクスだけでは表せない可能性が高いです。上記の EC サイトの例では、*メタ目標* である *1 時間あたりの売上* を特定した後、購入前の商品検索時間、チェックアウト処理時間、商品検索結果のレイテンシーなど、詳細なメトリクスを遡って特定できます。これにより、システムを観測するための関連情報を意図的に収集できるようになります。

!!! success
	KPI を特定したら、*ワーキングバックワード* して、それらに影響するワークロードのメトリクスを確認できます。

## オペレーショナルメトリクスデータと相関付ける

Web サーバーの高い CPU 使用率が応答時間の遅延を引き起こし、結果として顧客の不満につながり、最終的に収益が下がる場合、CPU 使用率を測定することは事業成果に直接影響するため、*絶対に* 測定する必要があります。

一方で、一時的なクラウドリソース (Amazon EC2 フリートなど、他のクラウドプロバイダー環境でも同様) でバッチ処理を実行するアプリケーションの場合、バッチを最も費用対効果の高い方法で完了させるために、CPU を可能な限り活用したい*かもしれません*。

いずれの場合も、オペレーショナルデータ (CPU 使用率など) をビジネスメトリクスと同じシステムに格納し、両者を相関付ける必要があります。

!!! success
	ビジネスメトリクスとオペレーショナルメトリクスを、相互に相関付けて、両者に観測された影響に基づいて結論を導くことができるシステムに格納してください。

## 正常な状態がどのようなものかを知る!

正常なベースラインがどのようなものかを理解するのは難しい場合があります。多くの人は、正常なメトリクスがどのようなものかを理解するために、ワークロードにストレステストを行う必要があります。ただし、ニーズによっては、既存の運用メトリクスを観察することで、正常な閾値について安全な結論を導き出すことができる場合があります。

正常なワークロードとは、KPI の目標を達成しながら、レジリエンス、可用性、コスト効率のバランスが取れているものです。

!!! success
	KPI には、必ず正常な範囲が特定されていなければなりません。そうすれば、パフォーマンスが要件を下回ったり上回ったりした場合に[アラーム](../../signals/alarms/)を作成できます。

## 異常検知アルゴリズムを使用する

[正常な状態がどのようなものかを知る](#know-what-good-looks-like)ことの課題は、システム内の*すべての*メトリクスの正常な閾値を知ることが現実的でない可能性があることです。リレーショナルデータベース管理システム (RDBMS) は数十のパフォーマンスメトリクスを出力でき、マイクロサービスアーキテクチャと組み合わせると、KPI に影響を与える可能性のある数百のメトリクスがある可能性があります。

このような大量のデータポイントを監視し、個別に上限値と下限値を特定することは、人間にとって常に実用的ではないかもしれません。しかし、機械学習はこのような反復的なタスクに*非常に*優れています。可能な限り自動化と機械学習を活用すると、気づかないままの問題を特定できる可能性があります!

!!! success
	機械学習アルゴリズムと異常検知モデルを使用して、ワークロードのパフォーマンス閾値を自動的に計算します。
