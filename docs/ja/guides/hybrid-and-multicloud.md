# ハイブリッドおよびマルチクラウドのベストプラクティス

## はじめに

マルチクラウドとは、自身のワークロードを運用するために複数のクラウドサービスプロバイダを併用することを指します。一方、ハイブリッドとは、オンプレミスとクラウド環境の両方にわたってワークロードを拡張することを意味します。ハイブリッドおよびマルチクラウド環境におけるオブザーバビリティは、ツールの多様性、レイテンシー、ワークロードの異種混在などにより、大きな複雑さを伴う可能性があります。それでも、開発者とビジネスユーザーの両方にとって、これは一般的な目標となっています。この課題に対処するための豊富な製品やサービスのエコシステムが存在します。

しかしながら、クラウドネイティブワークロードに対するオブザーバビリティツールの有用性は、大きく異なる場合があります。コンテナ化されたバッチ処理ワークロードを監視する要件と、サーバーレスフレームワークを使用したリアルタイムの銀行アプリケーションを監視する要件は大きく異なります。両者ともにログ、メトリクス、トレースがありますが、それらを観測するためのツールチェーンは異なり、クラウドネイティブ、オープンソース、ISVの製品が数多く利用可能です。Prometheusのようなオープンソースツールが適している場合もあれば、マネージドサービスとして提供されるクラウドネイティブツールがより要件を満たす場合もあります。

さらにマルチクラウドとハイブリッドの複雑さが加わると、アプリケーションから洞察を得ることはかなり難しくなります。

これらの追加された次元に対処し、オブザーバビリティへのアプローチを容易にするために、お客様は統一されたインターフェイスを持つ単一のツールチェーンに投資する傾向にあります。結局のところ、シグナル対ノイズ比を下げることは通常良いことです。しかし、単一のアプローチがすべてのユースケースに適しているわけではなく、さまざまなプラットフォームのオペレーティングモデルが混乱を招く可能性があります。私たちの目標は、お客様のニーズに合わせた適切な意思決定を支援し、問題が発生した際の平均修復時間を短縮することです。以下は、あらゆる規模のお客様、さまざまな業界で得た知見に基づくベストプラクティスです。

!!! info
    これらのベストプラクティスは、エンタープライズアーキテクト、開発者、DevOpsなど、幅広い役割を対象としています。組織のビジネスニーズと、分散環境におけるオブザーバビリティがどのように最大限の価値を提供できるかという観点から、これらを評価することをお勧めします。

## ツールに振り回されるな

アプリケーション、ツール、プロセスは、売上げや顧客満足度の向上など、ビジネス成果を達成するためのものです。賢明なテクノロジー戦略とは、それらのビジネス目標の達成を最大限支援するものです。しかし、そこに至る手段は単なるツールに過ぎず、戦略を支援するためのものであって、戦略そのものではありません。たとえ話をすれば、家を建てる必要があれば、ツールにどのように設計・建設するかを尋ねるわけではありません。ツールは目的を達成するための手段に過ぎません。

単一の同種環境であれば、ツールの選択は簡単です。結局、単一のアプリケーションを 1 つの環境で実行するのであれば、ツールも統一できます。しかし、ハイブリッドやマルチクラウド環境では事情が異なり、これらの環境全体でワークロードを観測することによる付加価値を見据えることが重要です。各クラウドサービスプロバイダー (CSP) には独自のオブザーバビリティソリューションがあり、パートナーや独立系ソフトウェアベンダー (ISV) の豊富な選択肢もあります。

複数の環境で運用しているからといって、すべてのワークロードに単一のツールを使うのが賢明だとは限りません。場合によっては、ワークロードを観測するために複数のサービス、フレームワーク、プロバイダーを使う必要があるかもしれません。オペレーティングモデルがニーズを反映する必要がある理由については、「[単一の操作画面よりもワークロードのコンテキストが重要](#a-single-pane-of-glass-is-less-important-than-your-workloads-context)」を参照してください。いずれにしろ、ツールを実装する際は、将来のオブザーバビリティソリューションの進化に対応できる「[両開きドア](https://aws.amazon.com/jp/executive-insights/content/how-amazon-defines-and-operationalizes-a-day-1-culture/)」を作成することを忘れずに。

避けるべき「ツール主導」の結果の例をいくつか挙げます。

1. 将来のアップグレードや新しいソリューションへの移行のための両開きドアを用意せずに、単一のツールの実装に集中すると、避けられたはずの技術的負債が生じる可能性があります。ツールがソリューションになり、いつかは解決すべき問題になってしまうかもしれません。
2. ボリュームディスカウントのために単一のツールを会社標準とすると、恩恵を受けられる機能がなくなる可能性があります。これは「コストを質に優先させる」ことになり、単一製品への偏りという反パターンを生み出してしまいます。ボリューム制限を下回るためにテレメトリの収集を控えがちになり、結果としてオブザーバビリティツールの使用が阻害されてしまいます。
3. トレース収集インフラがないために、トレースという種類のテレメトリ全体を収集しないと、ログやメトリクスの収集機能が充実していても、オブザーバビリティソリューションが不完全になってしまいます。
4. 労働力とトレーニングコストを削減したいがために、単一のツールチェーンのみを習得したサポート担当者では、他のオブザーバビリティパターンの価値を最大限に引き出せません。

!!! success
    ツールがオブザーバビリティ戦略を決めているのであれば、アプローチを逆転させる必要があります。ツールはオブザーバビリティを可能にし、力を与えるためのものであり、選択肢を制限するためのものではありません。

!!! success
    ツールの氾濫は、企業が直面する実在の問題ですが、単一のツールチェーンへの過激な移行も同様に、オブザーバビリティソリューションの有用性を低下させてしまいます。ハイブリッドやマルチクラウドのワークロードには、プラットフォームごとに固有の技術があり、各 CSP の上位レベルのサービスが役立ちます。ただし、単一のソースプロダクトを使用するメリットとデメリットを、価値に基づいて分析する必要があります。これらのリスクを軽減するアプローチについては、「[OpenTelemetry に投資する](#invest-in-opentelemetry)」を参照してください。

## (オブザーバビリティ) データには重力がある

すべてのデータには重力があり、つまり、そのデータの周りにワークロード、ソリューション、ツール、人、プロセス、プロジェクトが集まってくるということです。たとえば、顧客の取引データを含むデータベースがあれば、そのデータベースに計算リソースと分析ワークロードが引き付けられます。これは、ワークロードを配置する場所、どの環境に配置するか、今後どのように運用するかに直接影響します。オブザーバビリティのシグナルにも同じことが当てはまり、そのデータが生み出す重力はワークロードと組織のコンテキストに関連しています (「[単一のペインよりもワークロードのコンテキストの方が重要](#a-single-pane-of-glass-is-less-important-than-your-workloads-context)」を参照)。

オブザーバビリティのテレメトリのコンテキストを、関連する基盤となるワークロードやデータから完全に切り離すことはできません。同じルールがここでも適用されます。テレメトリはデータであり、重力があります。これは、テレメトリエージェント、コレクター、シグナルを集約・分析するシステムの配置場所に影響を与えるはずです。

!!! tip
    オブザーバビリティデータの価値は、ほとんどの他のデータタイプよりも時間の経過とともに大幅に低下します。これをオブザーバビリティデータの「半減期」と呼ぶことができます。別の環境にテレメトリを中継する際の追加の待ち時間は、そのデータが利用される前に強制的に価値が下がる可能性があることを考慮し、問題が発生したときのアラート要件と比較してみてください。

!!! success
    このような集約から事業価値が得られる場合にのみ、環境間でデータを送出するのがベストプラクティスです。データを問い合わせる単一のソースを持つだけでは、多くのビジネスニーズを解決できず、望んでいたよりも高価なソリューションになり、障害発生の可能性が高くなる可能性があります。

## 単一のペインよりもワークロードのコンテキストの方が重要

よくある要求は、すべてのワークロードを観察するための「単一のペイン」です。これは、できるだけシンプルな方法で可能な限り多くのデータを表示し、煩わしさ、フラストレーション、診断時間を減らしたいという自然な欲求から生まれます。一度にすべてのオブザーバビリティソリューションを見ることができるこの単一のインターフェースは便利ですが、テレメトリーがその発信元のコンテキストから切り離されてしまうというトレードオフがあります。

例えば、100台のサーバーの CPU 使用率を示すダッシュボードでは、消費量の異常なスパイクが表示されるかもしれません。しかし、これではなぜこのような状況が発生したのか、またこの動作の要因は何なのかを説明することはできません。また、このメトリクスの重要性も直ちには明らかではありません。

お客様の中には、単一のペインを非常に積極的に追求し過ぎて、すべてのビジネスコンテキストが失われてしまい、1つのツールですべてを見ようとすることで、実はそのデータの価値が薄れてしまうケースを見てきました。ダッシュボードやツールは、[ストーリーを語る](/observability-best-practices/ja/tools/dashboards/) 必要があります。そしてこのストーリーには、ワークロードのイベントによって影響を受けるビジネスメトリクスとアウトカムを含める必要があります。

さらに、ツールはオペレーティングモデルに合わせる必要があります。サポートチームがグローバルで、すべての環境にアクセスできる場合、単一のペインは価値を加えることができます。しかし、単一のワークロード、単一の CSP または ハイブリッド環境へのアクセスに限定されている場合、このアプローチでは付加価値はありません。このような場合、各環境内でチームがネイティブにダッシュボードを作成できるようにすれば、価値実現までの時間が短縮され、将来の変更にも柔軟に対応できます。

!!! success
    オブザーバビリティデータの価値は、発信元のアプリケーションと深く統合されています。テレメトリーには、その環境から得られるコンテキストの認識が必要です。ハイブリッドおよびマルチクラウド環境では、テクノロジーの違いによりコンテキストの必要性がさらに高まります (ただし、Kubernetes などのシステムは、異なるクラウドプロバイダーやオンプレミスでも同様の場合があります)。

!!! success
    分散システムの単一のペインを構築する際は、ビジネスメトリクスと Service Level Objectives (SLO) を、これらの SLO に貢献するその他のデータ (インフラストラクチャメトリクスなど) と同じビューに表示します。これにより、そうでなければ欠けてしまうコンテキストが提供されます。

!!! tip
    単一のペインは、問題の迅速な診断と検出時間 (MTTD) の短縮に役立ち、それによって平均復旧時間 (MTTR) も短縮できます。ただし、テレメトリーデータの意味が保持されている場合に限ります。そうでない場合、単一のペインのアプローチでは価値実現までの時間が長くなる可能性があり、運用チームにとってはマイナスになる可能性さえあります。

!!! success
    単一のペインの価値が判断できない場合、またはワークロードが単一の CSP やオンプレミス環境に完全に縛られている場合は、単一のペインにトップレベルのビジネスメトリクスのみをロールアップし、生のメトリクスやその他の寄与要因は元の環境に残すことを検討してください。

## OpenTelemetry への投資

オブザーバビリティベンダーの環境全体で、OpenTelemetry (OTel) がデファクトスタンダードになりました。OTel は、すべてのテレメトリタイプをクラウドネイティブサービスや様々な SaaS 製品や ISV 製品を含む 1 つ以上のコレクターにマーシャリングできます。OTel エージェントとコレクターは、OpenTelemetry プロトコル (OTLP) を使用して通信します。このプロトコルは、さまざまな展開パターンを可能にするフォーマットにシグナルをカプセル化します。

最も価値のあるトランザクショントレースを収集し、ビジネスとインフラストラクチャのコンテキストを含めるには、アプリケーションにトレース収集を統合する必要があります。一部の自動インストルメンテーションエージェントはほとんど手間をかけずにこれを実行できます。ただし、最も高度な使用例では、トランザクショントレースをサポートするためにコード変更が必要になります。これにより、技術的負債が発生し、ワークロードが特定のテクノロジーに縛られてしまいます。

OTel は、スパンという概念を使用してログ、メトリクス、トレースを収集します。スパンには、単一のトランザクションからグループ化されたこれらのシグナルが含まれ、コンテキスト化された検索可能なオブジェクトにパッケージ化されます。つまり、単一のアプリケーションイベントからのシグナルを 1 つの単純なエンティティで表示できます。たとえば、ユーザーがウェブサイトにログインし、これによって発生するすべてのダウンストリームサービスへのリクエストを、単一のスパンとして表示できます。

!!! tip
    OTel はアプリケーショントレースに限定されるものではなく、ログやメトリクスにも広く使用されています。また、多くの [ISV 製品が今日直接 OTLP を受け入れています](https://opentelemetry.io/ecosystem/vendors/)。

!!! Success
    OTel を使用してアプリケーションにインストルメンテーションを行うと、将来、別のオブザーバビリティプラットフォームに移行することを選択した場合でも、アプリケーション層でこのインストルメンテーションを置き換える必要がなくなります。これにより、オブザーバビリティソリューションの一部が [双方向のドア](https://aws.amazon.com/jp/executive-insights/content/how-amazon-defines-and-operationalizes-a-day-1-culture/) になります。

!!! success
    OTel は将来に備えたもので、スケーラブルであり、アプリケーションコードを変更することなく、将来の収集と分析システムを変更しやすくするため、[左へのシフト](https://www.youtube.com/watch?v=99r7cxKW8Rg) を効率的に行えます。
