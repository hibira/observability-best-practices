# ベストプラクティスの概要

オブザーバビリティは幅広いトピックで、成熟したツールの環境があります。しかし、すべてのツールがすべてのソリューションに適しているわけではありません。オブザーバビリティの要件、構成、最終的な展開を検討する際に、意思決定プロセスに役立つ 5 つの主要なベストプラクティスをまとめました。

## 重要なものを監視する

オブザーバビリティにおいて最も重要なのは、サーバー、ネットワーク、アプリケーション、顧客ではありません。重要なのは、*あなた*、あなたの事業、プロジェクト、ユーザーにとって何が重要かです。

まず最初に、成功の基準は何かを明確にしてください。例えば、EC サイトを運営している場合、過去 1 時間の購入数が成功の指標となるかもしれません。非営利団体の場合は、その月の目標に対する寄付金額が指標になるかもしれません。決済処理業者は取引処理時間を監視し、大学は学生の出席状況を測定したいと考えるでしょう。

!!! tip
	成功指標は誰もが異なります! ここでは EC サイトを例に使いますが、あなたのプロジェクトでは全く異なる指標になるかもしれません。しかし、アドバイスは同じです。「良い」状態とは何かを知り、それを測定することが重要です。

あなたのアプリケーションに関係なく、まずは重要なメトリクスを特定する必要があります。次に、アプリケーションやインフラストラクチャの観点から、それに影響を与えるものを *ワーキングバックワード[^1]* で特定します。例えば、Webサーバーの高 CPU 使用率が顧客満足度を下げ、結果として売上に影響を与える場合、CPU 使用率を監視することが重要になります。

#### 目標を知り、測定しましょう!

重要な上位レベルの KPI を特定したら、次は自動的に追跡・測定する方法を持つ必要があります。重要な成功要因は、ワークロードの運用を監視するのと同じシステムでそれを行うことです。e コマースワークロードの例では、以下のようになるかもしれません。

* 売上データを [*時系列*](https://en.wikipedia.org/wiki/Time_series) に公開する
* 同じシステムでユーザー登録を追跡する
* ユーザーがウェブページに滞在する時間を測定し、(再び) そのデータを時系列に送信する

ほとんどの顧客はすでにこのデータを持っていますが、オブザーバビリティの観点からは必ずしも適切な場所にはありません。売上データは通常、関係データベースやビジネスインテリジェンスレポートシステムで見つけられ、ユーザー登録も同様です。また、訪問時間のデータはログやリアルユーザーモニタリングから抽出できます。

メトリクスデータの元の場所やフォーマットに関係なく、[*時系列*](https://en.wikipedia.org/wiki/Time_series) として維持する必要があります。ビジネス、個人、学術、またはその他の目的に関わらず、最も重要なすべてのキーメトリクスは、他のオブザーバビリティデータ (シグナルまたはテレメトリとも呼ばれる) と相関させるために、時系列形式でなければなりません。

![時系列の例](../images/time_series.png)
*図1: 時系列の例*

## コンテキスト伝播とツールの選択

ツールの選択は重要であり、問題の運用と修復の方法に大きな違いをもたらします。しかし、最適ではないツールを選ぶよりも悪いのは、基本的なシグナルの種類すべてにツールを用意することです。たとえば、ワークロードから基本的な[ログ](../signals/logs)を収集しても、トランザクショントレースがないと、ギャップが生じます。その結果、アプリケーション全体の体験を一貫した視点で捉えられなくなります。オブザーバビリティの現代的なアプローチはすべて、アプリケーショントレースで「点と点を結ぶ」ことに依存しています。

健全性と運用の全体像を把握するには、[ログ](../signals/logs)、[メトリクス](../signals/metrics)、[トレース](../signals/traces)を収集し、相関関係の分析、[異常検知](../signals/anomalies)、[ダッシュボード](../tools/dashboards)、[アラーム](../tools/alarms)などを行うツールが必要です。

alert{type="info"}
一部のオブザーバビリティソリューションには上記のすべての機能が含まれていない場合がありますが、既存のシステムを補完、拡張、または付加価値を提供することを目的としています。いずれの場合も、オブザーバビリティプロジェクトを開始する際には、ツールの相互運用性と拡張性が重要な検討事項となります。


#### 各ワークロードは異なりますが、共通のツールを使えば結果が早く出せます

すべてのワークロードで共通のツールセットを使用することには、運用上の摩擦の軽減やトレーニングの削減などの付加的な利点があります。一般的に、ツールやベンダーの数を減らすよう努めるべきです。そうすれば、既存のオブザーバビリティソリューションを新しい環境やワークロードに素早くデプロイできるようになり、問題が発生した際の解決時間も短縮できます。

使用するツールは、基本的なインフラストラクチャ、アプリケーション、ウェブサイトなど、ワークロードのすべての層を観測できる広範なものである必要があります。単一のツールでは不可能な場合は、オープン標準に準拠し、オープンソースであり、したがって最も広範なクロスプラットフォーム統合が可能なものを使用するのがベストプラクティスです。

#### 既存のツールやプロセスと統合する

車の再発明をする必要はありません! 「円」はすでに素晴らしい形をしており、データサイロを作るのではなく、常に協調的でオープンなシステムを構築する必要があります。

* 既存のアイデンティティプロバイダー (Active Directory、SAML ベースの IdP など) と統合します。
* 既存の IT トラブル追跡システム (JIRA、ServiceNow など) がある場合は、問題が発生したらすぐに管理できるように統合します。
* 既存のワークロード管理やエスカレーションツール (PagerDuty、OpsGenie など) がある場合は、それらを使用してください!
* Ansible、SaltStack、CloudFormation、Terraform、CDK などのインフラストラクチャ as コードツールはすべて優れたツールです。これらを使用して、オブザーバビリティだけでなく他のすべてを管理し、すでに使用している同じインフラストラクチャ as コードツールを使用してオブザーバビリティソリューションを構築します ([オブザーバビリティを Day One から含める](#include-observability-from-day-one) を参照)。

#### 自動化と機械学習を活用する

コンピューターはパターンを見つけるのが得意で、データがパターンに従っていない場合も見つけることができます。モニターすべきデータポイントが数百、数千、あるいは数百万ある場合、それぞれの正常なしきい値を理解するのは不可能です。しかし、多くのオブザーバビリティソリューションには、データのベースラインを管理するための異常検知と機械学習の機能があります。

これを「正常な状態がどのようなものかを知ること」と呼びます。ワークロードを十分にロードテストしていれば、正常なパフォーマンスメトリクスはすでに分かっているかもしれません。しかし、複雑な分散アプリケーションの場合、すべてのメトリクスのベースラインを作成するのは扱いにくいものです。このような場合、異常検知、自動化、機械学習は非常に価値があります。

アプリケーションの正常性のベースラインと警報を管理するツールを活用することで、目標に集中し、[重要なものをモニターする](#monitor-what-matters)ことができます。

## ワークロードのすべての層からテレメトリを収集する

アプリケーションは単独で存在するものではありません。ネットワークインフラストラクチャ、クラウドプロバイダー、インターネットサービスプロバイダー、SaaS パートナー、およびコントロール内外の他のコンポーネントとの相互作用は、すべてアプリケーションの結果に影響を与える可能性があります。ワークロード全体を包括的に把握することが重要です。

#### 統合に注力する

インストルメンテーションを行う領域を 1 つ選ばなければならない場合、間違いなくコンポーネント間の統合になるでしょう。オブザーバビリティの力がもっとも明らかになるのはここです。原則として、あるコンポーネントまたはサービスが別のものを呼び出す際には、少なくとも以下のデータポイントを測定する必要があります。

1. リクエストとレスポンスの所要時間
2. レスポンスのステータス

そして、オブザーバビリティが要求する一貫性のある包括的なビューを作成するためには、収集されるシグナルに [リクエスト全体の単一の一意の識別子](../signals/traces) を含める必要があります。

#### エンドユーザーエクスペリエンスを忘れずに

ワークロードを完全に把握するには、エンドユーザーがどのように体験しているかを含むすべての層で理解する必要があります。ユーザーエクスペリエンスが悪いことでオブジェクティブが危険にさらされているかどうかを測定、定量化、理解することは、ディスク空き容量や CPU 使用率を監視するのと同じくらい、それ以上に重要です。

ワークロードがエンドユーザーと直接対話するもの (ウェブサイトやモバイルアプリとして提供されるアプリケーションなど) の場合、[Real User Monitoring](../tools/rum) はユーザーへの最終的な配信だけでなく、実際にユーザーがどのようにアプリケーションを体験したかを監視します。結局のところ、ユーザーがサービスを実際に利用できなければ、オブザーバビリティの旅は意味がありません。

## データは力になりますが、些細なことにこだわりすぎないでください

アプリケーションの規模によっては、シグナルを収集する対象のコンポーネントが非常に多くなる可能性があります。これを行うことは重要で有益ですが、努力に見合わない結果になることもあります。そのため、ベストプラクティスは [重要なものをモニタリングする](#monitor-what-matters) ことから始め、これを重要な統合と重要なコンンポーネントをマッピングする方法として活用し、適切な詳細に焦点を当てることです。

## 最初から Observability を含める

セキュリティと同様に、Observability は開発やオペレーションの後付けではあってはなりません。ベストプラクティスは、セキュリティと同様に、Observability を計画の早期に組み込むことです。これにより、人々が作業するためのモデルが作成され、アプリケーションの不透明な部分が減少します。メジャーな開発作業が完了した後にトランザクショントレースを追加するには時間がかかります。[自動インストルメンテーション](../../tools/traces)があっても同様です。しかし、その努力は大きな恩恵をもたらします。ただし、開発サイクルの後半でそうすると、作り直しが必要になる可能性があります。

後からワークロードに Observability を追加するのではなく、作業を *加速* するためにそれを活用しましょう。適切な[ログ](../signals/logs)、[メトリクス](../signals/metrics)、[トレース](../signals/traces)の収集により、アプリケーション開発が加速し、良い習慣が育ち、今後の迅速な問題解決の基盤が築かれます。

[^1]: Amazon では、顧客とその成果に執着するための方法として、*ワーキングバックワード* プロセスを広く活用しています。Observability ソリューションに取り組む人は、同様に自身の目的から後ろ向きに作業することを強くお勧めします。*ワーキングバックワード* の詳細は、[Werner Vogels のブログ](https://www.allthingsdistributed.com/2006/11/working_backwards.html)をご覧ください。
