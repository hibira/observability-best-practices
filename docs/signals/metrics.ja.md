# メトリクス

メトリクスとは、作成された時間とともに順序付けて保持される一連の数値です。これらは、環境内のサーバー数、ディスク使用量、1 秒あたりに処理するリクエスト数、またはこれらのリクエストの完了にかかるレイテンシーを追跡するために使用されます。

しかし、メトリクスはインフラストラクチャやアプリケーションの監視に限定されるものではありません。むしろ、販売、コールキュー、顧客満足度など、あらゆる種類のビジネスやワークロードを追跡するために使用できます。実際、運用データとビジネスメトリクスを組み合わせることで、包括的な視点と観測可能なシステムを実現できるのです。

メトリクスの追加のコンテキストは、[OpenTelemetry のドキュメンテーションページ](https://opentelemetry.io/docs/concepts/signals/metrics/)を参照する価値があるでしょう。

## 重要業績評価指標(KPI)を知り、それを測定しましょう!

メトリクスにおいて*最も*重要なことは、*正しいものを測定する*ことです。そしてそれらが何であるかは誰にとっても異なります。
eコマースアプリケーションでは、時間あたりの売上高が重要なKPIとなる一方で、ベーカリーでは1日あたりに作られるクロワッサンの数により関心がある可能性が高いでしょう。 

!!! warning
	ビジネスKPIの完全な単一の包括的なソースはありません。プロジェクトやアプリケーションを十分に理解して、*目標とするアウトプット*が何であるかを知る必要があります。

最初のステップは、上位目標を明確にします。ほとんどの場合、それらの目標はインフラからの単一のメトリクスだけで表されるものではありません。 
上記のeコマースの例では、*メタ*目標である*時間あたりの売上高*を特定したら、購入前の商品検索に費やされた時間、チェックアウトプロセスの完了に要した時間、商品検索結果のレイテンシなど、詳細なメトリクスに立ち返ることができます。 
これにより、システムを観察するための関連情報を意図的に収集することができるようになります。

!!! success
	KPIを特定したら、ワークロードのどのメトリクスがそれらに影響を与えるかを*逆から*確認できます。

## 運用メトリクスデータとの相関

Web サーバーの高い CPU 使用率が応答時間の低下を引き起こし、それが顧客の不満と最終的に収益の低下につながる場合、CPU 使用率を測定することはビジネスの成果に直接影響し、*絶対に*測定する必要があります!

または逆に、一時的なクラウドリソース(Amazon EC2 フリートなど)でバッチ処理を実行するアプリケーションの場合、バッチを最もコスト効率的に完了するために、CPU を可能な限り利用することが*望ましい*場合があります。

いずれにしても、運用データ(CPU 使用率など)をビジネスメトリクスと同じシステムに入れて、2 つのデータを相関付ける必要があります。

!!! success
	ビジネスメトリクスと運用メトリクスを、相関付けて両方への影響を観察した結論を導き出せるシステムに保存しましょう。

## 望ましい状態がどういう状態かを知る

健全なベースラインがどのような状態かを理解することは難しい場合があります。多くの人は、健全なメトリクスがどのように見えるかを理解するために、ワークロードのストレステストを行う必要があります。ただし、ニーズに応じて、運用メトリクスを観察して、健全なしきい値について安全な結論を導き出すことができます。

健全なワークロードとは、KPI 目標を満たしながらも回復力が高く、可用性が高く、コスト効果の高いバランスの取れた状態です。

!!! success
	KPI には、パフォーマンスが必要なレベルを下回ったり超えたりした場合に[アラーム](../../signals/alarms/)を作成できるように、健全な範囲を特定する必要があります。

## 異常検知アルゴリズムを利用する

[正常な状態がどういう状態なのかを知ること](#know-what-good-looks-like) の課題は、システム内の*すべての*メトリクスについて、正常なしきい値を知ることが現実的でない場合があることです。 リレーショナル・データベース・マネジメント・システム(RDBMS)は数十ものパフォーマンス・メトリクスを発行でき、マイクロサービス・アーキテクチャと組み合わせると、KPI に影響を与える可能性のあるメトリクスが潜在的に数百個になる場合があります。

このような大量のデータポイントを監視し、個々の上限値と下限値を特定することは、人間にとって常に実用的というわけではありません。しかし、機械学習はこの種の反復作業に*非常に*長けています。可能な限り自動化と機械学習を活用しましょう。そうすることで、そうでなければ認識すらしなかったであろう問題を特定するのに役立ちます。

!!! success
	機械学習アルゴリズムと異常検知モデルを使用して、ワークロードのパフォーマンスしきい値を自動的に計算します。
